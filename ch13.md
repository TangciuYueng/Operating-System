## 磁盘管理
### 磁盘结构
#### 外存
关心**速度、可靠性**
特点
- 容量大、断电后可保存信息，速度较慢
- 组成部分：驱动部分(外设) + 存储介质
- 种类很多
- 外存空间组织和存取方式复杂
存储介质
- 磁带
  - 永久保存大容量数据
  - 顺序存取设备
  - 存取速度较慢，主要用于后备存储
- 磁盘
  - 随机存取设备
  - 磁盘认为数据块的物理地址三维的：盘面号、磁道号、扇区号
    - 磁道：圆形轨迹，磁道之间有间隔防止干扰
    - 扇区：圆形轨迹的弧段
  - 但OS认为数据块的物理地址最好是一维的：第几块就好
- 光盘
  - 容量大、速度块、价格便宜
  - 一般不可写，可写的很贵
  - 空间结构与磁盘类似
- 硬盘分类
  - 固定头磁盘
    每个磁道设置一个磁头，变换磁道时不需要磁头的机械移动
    成本高速度快
  - 移动头磁盘
    一个盘面只有一个磁头，变换磁道时候需要移动磁头
    成本低速度块
  磁头：感应磁介质的方向，转换为电信号
- 磁盘读取时间
  要改进先减少前两个的时间
  - 寻道时间
    机械运动，时间最长，磁头定位到指定磁道
  - 旋转延迟
    指定扇区从磁头下旋转经过
      - 转速，极限了目前
      - OS不按顺序编号，转到i了读了之后再读以为是i+1结果是i+2
  - 数据传输
    存取，与磁盘无关了
#### 使用要求
- 用户对外存的使用：读写外存数据
- 用户对外存的要求：方便、效率、安全
  - 不涉及硬件细节
  - 速度尽可能块，空间利用率高
  - 存放信息安全可靠
  - 方便共享、动态扩缩、携带拆卸
  - 尽可能小代价
#### 磁盘调度
目的
- 公平性，一个I/O请求在有限时间内满足
- 高效性：减少设备机械运动花费时间
方法
- 先来先服务(FCFS)
    按访问请求到达的先后次序服务
    优点：公平简单
    缺点：效率不高，相邻两次请求可能造成最外的柱面寻道，使磁头反复移动，增加了服务的时间，对机械不利
![](./ref/ch13_1.png)
- 最短寻道时间优先(SSTF)
    优先选择距当前磁头最近的访问请求进行服务，主要考虑寻道优先
    优点：改善了磁盘平均服务时间
    缺点：造成某些访问请求长期等待不到服务
![](./ref/ch13_2.png)
- 扫描算法(电梯算法，双向扫描)
![](./ref/ch13_3.png)
- 单向扫描算法
![](./ref/ch13_4.png)
### 磁盘管理
#### 格式化
- 低级格式化
  - 将磁盘分成磁盘控制器能读与写的扇区
  - 每个扇区数据结构由头、数据区域和尾部组成；头部和尾部包含一些磁盘控制器所使用的信息，如扇区号和纠错代码等
  - 磁盘出厂的时候就做好了
- 高级格式化
  - 分区
  - 逻辑格式化
#### 引导区
引导快
绝大多数系统只在启动ROM中保留一个很小的自举装入程序，其作用是进一步从磁盘上调入更为完整的启动程序（保存在磁盘的启动块上）
#### 坏块
坏块区
对于简单的磁盘，坏扇区可手工处理
- Format
- Chkdsk
对于复杂的磁盘，对坏块的处理更为聪明
- 扇区备用或转寄
### 可靠性
#### 容错技术
磁盘容错技术：通过增加冗余的磁盘驱动器，磁盘控制器等来提高磁盘系统可靠性
廉价磁盘冗余阵列RAID
#### SFT-1技术
只能用于防止由磁盘表面部分故障造成的数据丢失
- 主要措施
- 双份目录和双份文件分配表
  - Windows中的FAT表
- 热修复重定向
  - 系统将一定的磁盘容量(例如2％-3％)作为热修复重定向区，用于存放当发现盘块有缺陷时写数据，并对写入该区的所有数据进行登记，以便于以后对数据进行访问
#### SFT-2技术
磁盘镜像
- 在同一磁盘控制器下，**增设一个完全相同的磁盘驱动器**；采用磁盘镜像工作方式时，每次向文件服务器的主磁盘写入数据后，采用写后读校验方式，将数据再同样地写到备份磁盘上
- 磁盘镜像实现了容错功能，但并未能使服务器的磁盘I/O速度得到提高，磁盘利用率仅为50％
- 有效解决在一台磁盘机故障时的数据保护问题
磁盘双工
- 将两台磁盘驱动器分别接到两个磁盘控制器上，磁盘机镜像成对
- 文件服务器同时将数据写到两个处于不同控制器下的磁盘上，使两者有着完全相同的位像图。如果某个通道或控制器发生故障时，另一通道上的磁盘仍能正常工作，这样便不会造成数据的丢失，同时须立即发出警告，以便尽早恢复磁盘双工功能
#### SFT-3技术
RAID廉价磁盘冗余阵列
技术特点：并行交叉存取
优点
- 可靠性高
- 磁盘I/O速度高
- 性价比高